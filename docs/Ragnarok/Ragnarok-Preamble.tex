\documentclass[11pt]{article}

% -------- Engine guard: MUST use XeLaTeX --------
\usepackage{iftex}
\ifXeTeX
  % ok
\else
  \errmessage{This document must be compiled with XeLaTeX (not pdfLaTeX).}
\fi

% -------- Unicode + Fonts --------
\usepackage{fontspec}
\usepackage{newunicodechar}

% Map specific Unicode characters that cause trouble
\newunicodechar{ }{\quad} % U+2003 EM SPACE -> LaTeX \quad
% (add more mappings here if you see "Unicode character ... not set up" errors)

\defaultfontfeatures{Ligatures=TeX, Scale=MatchLowercase}

% Body text = Georgia (system font)
\setmainfont{Georgia}

% Sans + mono
\setsansfont{Georgia}
\setmonofont{Latin Modern Mono}

% -------- Character fonts (voices) --------
% Make sure these names match installed fonts on your system.
% If TeX can't find them, you'll get a clear fontspec error.

% Kara – The Girl Next Door
\newfontfamily\KaraFont{The Girl Next Door}[Scale=1.0]

% Heinrikr – Permanent Marker
\newfontfamily\HeinFont{Permanent Marker}[Scale=1.0]

% Astrid – La Belle Aurore
\newfontfamily\AstridFont{La Belle Aurore}[Scale=1.0]

% -------- Convenience macros / environments for dialogue --------

% Inline voice switches
\newcommand{\kara}[1]{{\KaraFont #1}}
\newcommand{\heinrikr}[1]{{\HeinFont #1}}
\newcommand{\astrid}[1]{{\AstridFont #1}}

% Block dialogue environments
\newenvironment{KaraBlock}{\begin{quote}\KaraFont}{\end{quote}}
\newenvironment{HeinBlock}{\begin{quote}\HeinFont}{\end{quote}}
\newenvironment{AstridBlock}{\begin{quote}\AstridFont}{\end{quote}}

% Kàra "notes" where each source newline = output line
\newenvironment{karanotes}{%
  \par\begingroup
  \KaraFont
  \obeylines
  \setlength{\parindent}{0pt}%
  \setlength{\parskip}{0pt}%
}{%
  \par\endgroup
}

% -------- TikZ for scattered Kàra thoughts --------
\usepackage{tikz}
\usetikzlibrary{calc}
\pgfmathsetseed{12345} % change this for a different random layout

% One Kàra sentence placed at a random vertical position on the page
\newcommand{\kararandom}[1]{%
  \begin{tikzpicture}[remember picture,overlay]
    % Random number between 0 and 0.8 of the page height
    \pgfmathsetmacro{\yrand}{rand*0.8}%
    % Shift from top of page downward
    \node[
      anchor=west,
      xshift=3em,
      yshift=-\yrand\paperheight,
      text width=0.6\paperwidth,
      inner sep=0pt
    ] at (current page.north west) {%
      {\KaraFont #1}%
    };
  \end{tikzpicture}%
}

% -------- Language, layout, etc. --------
\usepackage[english]{babel}
\usepackage[a4paper,margin=1in]{geometry}
\usepackage{microtype}
\usepackage{amsmath,amssymb,mathtools}
\usepackage{csquotes}

% hyperref LAST
\usepackage[colorlinks=true,linkcolor=blue,urlcolor=blue]{hyperref}

% Paragraph look
\linespread{1.1}
\setlength{\parskip}{0.5em}
\setlength{\parindent}{0pt}
